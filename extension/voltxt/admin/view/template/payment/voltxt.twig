{{ header }}{{ column_left }}
<div id="content">
  <div class="page-header">
    <div class="container-fluid">
      <div class="float-end">
        <button type="submit" form="form-payment" data-bs-toggle="tooltip" title="{{ button_save }}" class="btn btn-primary"><i class="fa-solid fa-floppy-disk"></i></button>
        <a href="{{ back }}" data-bs-toggle="tooltip" title="{{ button_cancel }}" class="btn btn-light"><i class="fa-solid fa-reply"></i></a>
      </div>
      <h1>{{ heading_title }}</h1>
      <ol class="breadcrumb">
        {% for breadcrumb in breadcrumbs %}
          <li class="breadcrumb-item"><a href="{{ breadcrumb.href }}">{{ breadcrumb.text }}</a></li>
        {% endfor %}
      </ol>
    </div>
  </div>
  <div class="container-fluid">
    <div class="card">
      <div class="card-header"><i class="fa-solid fa-pencil"></i> {{ text_edit }}</div>
      <div class="card-body">
        <form id="form-payment" action="{{ save }}" method="post" data-oc-toggle="ajax">
          
          {% if error_warning %}
          <div class="alert alert-danger alert-dismissible fade show"><i class="fa-solid fa-circle-exclamation"></i> {{ error_warning }} <button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>
          {% endif %}
          
          <ul class="nav nav-tabs">
            <li class="nav-item"><a href="#tab-general" data-bs-toggle="tab" class="nav-link active">{{ tab_general }}</a></li>
            <li class="nav-item"><a href="#tab-order-status" data-bs-toggle="tab" class="nav-link">{{ tab_order_status }}</a></li>
            <li class="nav-item"><a href="#tab-advanced" data-bs-toggle="tab" class="nav-link">{{ tab_advanced }}</a></li>
          </ul>
          
          <div class="tab-content">
            
            <div id="tab-general" class="tab-pane active">
              <div class="row mb-3 required">
                <label for="input-api-key" class="col-sm-2 col-form-label">{{ entry_api_key }}</label>
                <div class="col-sm-10">
                  <input type="text" name="payment_voltxt_api_key" value="{{ payment_voltxt_api_key }}" placeholder="{{ entry_api_key }}" id="input-api-key" class="form-control" maxlength="32" required/>
                  <div class="form-text">{{ help_api_key }}</div>
                  <div id="error-api-key" class="invalid-feedback"></div>
                </div>
              </div>
              
              <div class="row mb-3">
                <label for="input-network" class="col-sm-2 col-form-label">{{ entry_network }}</label>
                <div class="col-sm-10">
                  <select name="payment_voltxt_network" id="input-network" class="form-select">
                    <option value="testnet"{% if payment_voltxt_network == 'testnet' %} selected{% endif %}>{{ text_testnet }}</option>
                    <option value="mainnet"{% if payment_voltxt_network == 'mainnet' %} selected{% endif %}>{{ text_mainnet }}</option>
                  </select>
                  <div class="form-text">{{ help_network }}</div>
                </div>
              </div>
              
              <div class="row mb-3">
                <label for="input-expiry-hours" class="col-sm-2 col-form-label">{{ entry_expiry_hours }}</label>
                <div class="col-sm-10">
                  <input type="number" name="payment_voltxt_expiry_hours" value="{{ payment_voltxt_expiry_hours }}" placeholder="{{ entry_expiry_hours }}" id="input-expiry-hours" class="form-control" min="1" max="168" required/>
                  <div class="form-text">{{ help_expiry_hours }}</div>
                  <div id="error-expiry-hours" class="invalid-feedback"></div>
                </div>
              </div>
              
              <div class="row mb-3">
                <label class="col-sm-2 col-form-label">{{ entry_test_connection }}</label>
                <div class="col-sm-10">
                  <button type="button" id="test-connection-btn" class="btn btn-info">
                    <i class="fa-solid fa-plug"></i> {{ button_test_connection }}
                  </button>
                  <div class="form-text">{{ help_test_connection }}</div>
                  <div id="test-connection-result" class="mt-2"></div>
                </div>
              </div>
              
              <div class="row mb-3">
                <label class="col-sm-2 col-form-label">{{ text_webhook_url }}</label>
                <div class="col-sm-10">
                  <div class="input-group">
                    <input type="text" value="{{ webhook_url }}" class="form-control" readonly/>
                    <button type="button" class="btn btn-outline-secondary" onclick="copyWebhookUrl(this)">
                      <i class="fa-solid fa-copy"></i>
                    </button>
                  </div>
                  <div class="form-text">{{ help_webhook_url }}</div>
                </div>
              </div>
            </div>
            
            <div id="tab-order-status" class="tab-pane">
              <div class="row mb-3">
                <label for="input-order-status" class="col-sm-2 col-form-label">{{ entry_order_status }}</label>
                <div class="col-sm-10">
                  <select name="payment_voltxt_order_status_id" id="input-order-status" class="form-select">
                    {% for order_status in order_statuses %}
                      <option value="{{ order_status.order_status_id }}"{% if order_status.order_status_id == payment_voltxt_order_status_id %} selected{% endif %}>{{ order_status.name }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
              
              <div class="row mb-3">
                <label for="input-pending-status" class="col-sm-2 col-form-label">{{ entry_pending_status }}</label>
                <div class="col-sm-10">
                  <select name="payment_voltxt_pending_status_id" id="input-pending-status" class="form-select">
                    {% for order_status in order_statuses %}
                      <option value="{{ order_status.order_status_id }}"{% if order_status.order_status_id == payment_voltxt_pending_status_id %} selected{% endif %}>{{ order_status.name }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
              
              <div class="row mb-3">
                <label for="input-cancelled-status" class="col-sm-2 col-form-label">{{ entry_cancelled_status }}</label>
                <div class="col-sm-10">
                  <select name="payment_voltxt_cancelled_status_id" id="input-cancelled-status" class="form-select">
                    {% for order_status in order_statuses %}
                      <option value="{{ order_status.order_status_id }}"{% if order_status.order_status_id == payment_voltxt_cancelled_status_id %} selected{% endif %}>{{ order_status.name }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
              
              <div class="row mb-3">
                <label for="input-failed-status" class="col-sm-2 col-form-label">{{ entry_failed_status }}</label>
                <div class="col-sm-10">
                  <select name="payment_voltxt_failed_status_id" id="input-failed-status" class="form-select">
                    {% for order_status in order_statuses %}
                      <option value="{{ order_status.order_status_id }}"{% if order_status.order_status_id == payment_voltxt_failed_status_id %} selected{% endif %}>{{ order_status.name }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
            </div>
            
            <div id="tab-advanced" class="tab-pane">
              <div class="row mb-3">
                <label for="input-geo-zone" class="col-sm-2 col-form-label">{{ entry_geo_zone }}</label>
                <div class="col-sm-10">
                  <select name="payment_voltxt_geo_zone_id" id="input-geo-zone" class="form-select">
                    <option value="0">{{ text_all_zones }}</option>
                    {% for geo_zone in geo_zones %}
                      <option value="{{ geo_zone.geo_zone_id }}"{% if geo_zone.geo_zone_id == payment_voltxt_geo_zone_id %} selected{% endif %}>{{ geo_zone.name }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
              
              <div class="row mb-3">
                <label for="input-status" class="col-sm-2 col-form-label">{{ entry_status }}</label>
                <div class="col-sm-10">
                  <div class="form-check form-switch form-switch-lg">
                    <input type="hidden" name="payment_voltxt_status" value="0"/>
                    <input type="checkbox" name="payment_voltxt_status" value="1" id="input-status" class="form-check-input"{% if payment_voltxt_status %} checked{% endif %}/>
                  </div>
                </div>
              </div>
              
              <div class="row mb-3">
                <label for="input-sort-order" class="col-sm-2 col-form-label">{{ entry_sort_order }}</label>
                <div class="col-sm-10">
                  <input type="text" name="payment_voltxt_sort_order" value="{{ payment_voltxt_sort_order }}" placeholder="{{ entry_sort_order }}" id="input-sort-order" class="form-control"/>
                </div>
              </div>
              
              <div class="row mb-3">
                <label for="input-debug" class="col-sm-2 col-form-label">{{ entry_debug }}</label>
                <div class="col-sm-10">
                  <div class="form-check form-switch">
                    <input type="hidden" name="payment_voltxt_debug" value="0"/>
                    <input type="checkbox" name="payment_voltxt_debug" value="1" id="input-debug" class="form-check-input"{% if payment_voltxt_debug %} checked{% endif %}/>
                  </div>
                  <div class="form-text">{{ help_debug }}</div>
                </div>
              </div>
              
              <div class="row mb-3">
                <label class="col-sm-2 col-form-label">{{ text_version }}</label>
                <div class="col-sm-10">
                  <p class="form-control-plaintext">{{ text_voltxt_version }}</p>
                </div>
              </div>
            </div>
            
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script type="text/javascript">
$(document).ready(function() {
    $('#test-connection-btn').on('click', function() {
        var btn = $(this);
        var result = $('#test-connection-result');
        var apiKey = $('#input-api-key').val();
        var network = $('#input-network').val();
        
        $('#input-api-key').removeClass('is-invalid');
        $('#error-api-key').html('');

        if (!apiKey) {
            $('#input-api-key').addClass('is-invalid');
            $('#error-api-key').html('{{ error_api_key_required }}');
            result.html('<div class="alert alert-warning"><i class="fa-solid fa-triangle-exclamation"></i> {{ error_api_key_required }}</div>');
            return;
        }
        
        if (apiKey.length !== 32) {
            $('#input-api-key').addClass('is-invalid');
            $('#error-api-key').html('{{ error_api_key_length }}');
            result.html('<div class="alert alert-warning"><i class="fa-solid fa-triangle-exclamation"></i> {{ error_api_key_length }}</div>');
            return;
        }
        
        btn.prop('disabled', true);
        btn.html('<i class="fa-solid fa-spinner fa-spin"></i> {{ text_testing_connection }}');
        result.html('<div class="alert alert-info"><i class="fa-solid fa-info-circle"></i> {{ text_testing_connection }}</div>');
        
        $.ajax({
            url: '{{ test_connection_url }}',
            type: 'POST',
            data: {
                api_key: apiKey,
                network: network,
                user_token: '{{ user_token }}'
            },
            dataType: 'json',
            success: function(data) {
                if (data.success) {
                    var walletStatus = data.has_wallet ? 
                        '<span class="text-success"><i class="fa-solid fa-check"></i> {{ text_wallet_configured }}</span>' : 
                        '<span class="text-warning"><i class="fa-solid fa-triangle-exclamation"></i> {{ text_wallet_not_configured }}</span>';
                    
                    var message = '{{ text_connection_success }}';
                    if (!data.has_wallet) {
                        message += '<br><strong class="text-warning">{{ warning_no_wallet }}</strong>';
                    }

                    result.html(
                        '<div class="alert alert-success">' +
                        '<i class="fa-solid fa-check-circle"></i> ' + message +
                        '<br><strong>{{ text_store_name }}:</strong> ' + data.store_name +
                        '<br><strong>{{ text_store_network }}:</strong> ' + data.network +
                        '<br><strong>{{ text_wallet_status }}:</strong> ' + walletStatus +
                        '</div>'
                    );
                } else {
                    result.html('<div class="alert alert-danger"><i class="fa-solid fa-times-circle"></i> ' + (data.error || '{{ error_connection_failed }}') + '</div>');
                }
            },
            error: function(xhr, status, error) {
                result.html('<div class="alert alert-danger"><i class="fa-solid fa-times-circle"></i> {{ error_connection_failed }}: ' + error + '</div>');
            },
            complete: function() {
                btn.prop('disabled', false);
                btn.html('<i class="fa-solid fa-plug"></i> {{ button_test_connection }}');
            }
        });
    });
    
    $('#form-payment').on('oc.ajax:complete', function(event, jqXHR, textStatus) {
        $(this).find('.is-invalid').removeClass('is-invalid');
        $(this).find('.invalid-feedback').remove();

        var json = jqXHR.responseJSON;

        if (json && json.error) {
            if (json.error.warning) {
                $('#content').prepend('<div class="alert alert-danger alert-dismissible fade show"><i class="fa-solid fa-circle-exclamation"></i> ' + json.error.warning + ' <button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>');
            }
            if (json.error.api_key) {
                $('#input-api-key').addClass('is-invalid').after('<div class="invalid-feedback">' + json.error.api_key + '</div>');
            }
            if (json.error.expiry_hours) {
                $('#input-expiry-hours').addClass('is-invalid').after('<div class="invalid-feedback">' + json.error.expiry_hours + '</div>');
            }
        } else if (json && json.success) {
            $('#content').prepend('<div class="alert alert-success alert-dismissible fade show"><i class="fa-solid fa-circle-check"></i> ' + json.success + ' <button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>');
        }
    });
});

function copyWebhookUrl(button) {
    var webhookInput = $(button).siblings('input[type="text"]');
    webhookInput.select();
    document.execCommand('copy');
    
    var btn = $(button);
    var originalIcon = btn.html();
    btn.html('<i class="fa-solid fa-check"></i>');
    btn.addClass('btn-success').removeClass('btn-outline-secondary');
    
    setTimeout(function() {
        btn.html(originalIcon);
        btn.removeClass('btn-success').addClass('btn-outline-secondary');
    }, 2000);
}
</script>

{{ footer }}